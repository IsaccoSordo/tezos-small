/**
 * Environment File Generator
 *
 * Generates Angular environment files from environment variables.
 * Used in CI/CD pipelines (GitHub Actions) to inject secrets at build time.
 *
 * Usage:
 *   npx ts-node scripts/set-env.ts          # Generates both environment files
 *   npx ts-node scripts/set-env.ts --prod   # Generates only production environment
 *
 * Required environment variables:
 *   FIREBASE_API_KEY
 *   FIREBASE_PROJECT_ID
 *   FIREBASE_APP_ID
 *   FIREBASE_SENDER_ID
 */

import { writeFileSync, mkdirSync, existsSync } from 'fs';
import { join } from 'path';

interface FirebaseConfig {
  apiKey: string;
  authDomain: string;
  projectId: string;
  storageBucket: string;
  messagingSenderId: string;
  appId: string;
}

interface Environment {
  production: boolean;
  firebase: FirebaseConfig;
}

function getEnvVar(name: string, fallback = ''): string {
  return process.env[name] || fallback;
}

function generateEnvironmentContent(env: Environment): string {
  return `// This file is auto-generated. Do not edit manually.
// Generated by scripts/set-env.ts

export const environment = {
  production: ${env.production},
  firebase: {
    apiKey: '${env.firebase.apiKey}',
    authDomain: '${env.firebase.authDomain}',
    projectId: '${env.firebase.projectId}',
    storageBucket: '${env.firebase.storageBucket}',
    messagingSenderId: '${env.firebase.messagingSenderId}',
    appId: '${env.firebase.appId}',
  },
};
`;
}

function createFirebaseConfig(): FirebaseConfig {
  const projectId = getEnvVar('FIREBASE_PROJECT_ID', 'YOUR_PROJECT_ID');

  return {
    apiKey: getEnvVar('FIREBASE_API_KEY', 'YOUR_API_KEY'),
    authDomain: `${projectId}.firebaseapp.com`,
    projectId: projectId,
    storageBucket: `${projectId}.appspot.com`,
    messagingSenderId: getEnvVar('FIREBASE_SENDER_ID', 'YOUR_SENDER_ID'),
    appId: getEnvVar('FIREBASE_APP_ID', 'YOUR_APP_ID'),
  };
}

function main(): void {
  const args = process.argv.slice(2);
  const prodOnly = args.includes('--prod');

  const environmentsDir = join(__dirname, '..', 'src', 'environments');

  // Ensure environments directory exists
  if (!existsSync(environmentsDir)) {
    mkdirSync(environmentsDir, { recursive: true });
  }

  const firebaseConfig = createFirebaseConfig();

  // Generate development environment
  if (!prodOnly) {
    const devEnv: Environment = {
      production: false,
      firebase: firebaseConfig,
    };

    const devPath = join(environmentsDir, 'environment.ts');
    writeFileSync(devPath, generateEnvironmentContent(devEnv));
    console.log(`Generated: ${devPath}`);
  }

  // Generate production environment
  const prodEnv: Environment = {
    production: true,
    firebase: firebaseConfig,
  };

  const prodPath = join(environmentsDir, 'environment.prod.ts');
  writeFileSync(prodPath, generateEnvironmentContent(prodEnv));
  console.log(`Generated: ${prodPath}`);

  // Validate that real values are set (warn if placeholders detected)
  const hasPlaceholders = Object.values(firebaseConfig).some(
    (value) =>
      value.includes('YOUR_') || value === '' || value === 'undefined'
  );

  if (hasPlaceholders) {
    console.warn(
      '\nWarning: Some environment variables are not set. Using placeholder values.'
    );
    console.warn('Required environment variables:');
    console.warn('  - FIREBASE_API_KEY');
    console.warn('  - FIREBASE_PROJECT_ID');
    console.warn('  - FIREBASE_APP_ID');
    console.warn('  - FIREBASE_SENDER_ID');
  }
}

main();
